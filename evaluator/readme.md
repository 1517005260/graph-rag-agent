# 评估系统指标计算原理与总结

## 评估指标的计算原理

本文档介绍GraphRAG评估系统中各项指标的计算原理和评分机制，以及LLM回退评分策略。

## 1. 通用评分机制

所有评估指标采用0到1的分数范围，其中：
- 0.0-0.3: 表现较差
- 0.4-0.7: 表现一般
- 0.8-1.0: 表现优秀

评估系统采用双层评分机制：
1. **规则评分**：基于预定义规则和数据统计计算初步分数
2. **LLM回退**：当规则评分较低或不可靠时，使用LLM进行更智能的评估

最终采用规则评分和LLM评分中的较高值，确保评估结果更合理。

## 2. 答案质量评估指标

### 2.1 精确匹配 (Exact Match)

**计算原理**：
- 标准化处理系统答案和参考答案（去除标点、冠词等）
- 检查完全匹配情况，匹配则得分1.0
- 不完全匹配时：
  1. 计算内容相似度，基于共有词计算Jaccard相似度
  2. 相似度高时给予0.7-1.0分
  3. 相似度一般时使用LLM评估答案的等价性

**LLM回退策略**：
- 提供系统答案和参考答案，让LLM评估内容等价性
- 基于关键信息点的匹配程度给出分数

### 2.2 F1分数 (F1 Score)

**计算原理**：
- 对答案进行中文分词并过滤停用词
- 计算共有词的比例，得出精确率和召回率
- F1 = 2 * 精确率 * 召回率 / (精确率 + 召回率)
- 当精确率和召回率为0时，F1分数为0

**LLM回退策略**：
- 无论规则F1分数如何，都尝试使用LLM评估内容相似度
- 比较LLM评分和规则F1分数，取较高值

### 2.3 答案连贯性 (Response Coherence)

**计算原理**：
- 分析答案的结构特征：段落数、标题、句子数等
- 基于结构完整性和逻辑流畅程度评分
- 主要依赖LLM评估连贯性

### 2.4 事实一致性 (Factual Consistency)

**计算原理**：
- 提取答案中的关键信息点
- 评估信息点之间的逻辑一致性
- 检查是否存在自相矛盾
- 主要依赖LLM评估

### 2.5 答案全面性 (Answer Comprehensiveness)

**计算原理**：
- 评估答案是否涵盖问题的所有方面
- 检查答案的信息密度和详尽程度
- 主要依赖LLM评估

## 3. 检索性能评估指标

### 3.1 检索精确率 (Retrieval Precision)

**计算原理**：
- 比较检索到的实体和引用的实体的匹配程度
- 计算引用实体在检索实体中的出现比例
- 公式：matched / 引用实体总数

**LLM回退策略**：
- 当规则评分不佳时，提供检索实体、引用实体和回答给LLM
- LLM评估引用实体与检索实体的匹配程度

### 3.2 检索利用率 (Retrieval Utilization)

**计算原理**：
- 评估系统对检索到的实体的利用程度
- 检查引用实体在检索实体中的覆盖率
- 考虑部分匹配和相似性

**LLM回退策略**：
- 提供检索实体、引用实体和系统回答给LLM
- LLM评估系统对检索实体的利用充分程度

### 3.3 检索延迟 (Retrieval Latency)

**计算原理**：
- 记录从提问到获得回答的时间（秒）
- 直接报告原始时间值，不进行转换

### 3.4 文本块利用率 (Chunk Utilization)

**计算原理**：
- 从Neo4j获取引用文本块的实际内容
- 提取文本块的关键短语
- 计算关键短语在回答中的出现比例
- 平均所有文本块的利用率

**LLM回退策略**：
- 向LLM提供文本块内容样例和系统回答
- LLM评估回答对文本块内容的利用程度
- 当无法获取文本块内容时仍能基于ID进行评估

## 4. 图评估指标

### 4.1 实体覆盖率 (Entity Coverage)

**计算原理**：
- 获取引用的实体信息和描述
- 提取问题关键词
- 计算关键词在实体信息中的匹配率
- 考虑实体数量和匹配质量

**LLM回退策略**：
- 当分数较低时，提供实体信息和问题关键词给LLM
- LLM评估实体与问题的相关程度

### 4.2 图覆盖率 (Graph Coverage)

**计算原理**：
- 评估三个维度：结构得分、相关性得分和连通性得分
- 结构得分：基于实体和关系的数量及质量
- 相关性得分：关键词在图数据中的匹配率
- 连通性得分：实体之间的连接度

**LLM回退策略**：
- 提供实体、关系和问题信息给LLM
- LLM评估图数据与问题的相关程度和覆盖范围

### 4.3 关系利用率 (Relationship Utilization)

**计算原理**：
- 计算数量得分：基于关系数量
- 计算质量得分：基于关系描述质量和多样性
- 计算相关性得分：关系中实体与引用实体的重合度
- 加权平均三个维度的分数

**LLM回退策略**：
- 提供关系信息、实体信息和回答给LLM
- LLM评估系统对实体间关系的利用程度

### 4.4 子图质量 (Subgraph Quality)

**计算原理**：
- 计算图密度：边数与最大可能边数之比
- 计算连通性：参与关系的实体比例
- 加权平均密度和连通性得分

**LLM回退策略**：
- 提供子图结构信息（实体数量、关系数量）给LLM
- LLM评估子图的质量和信息密度

### 4.5 社区相关性 (Community Relevance)

**计算原理**：
- 查询实体关联的社区信息
- 计算问题关键词在社区信息中的匹配率
- 根据代理类型给予不同基础分和加成

**LLM回退策略**：
- 提供实体、问题关键词和回答给LLM
- LLM评估回答与知识社区的相关程度

## 5. LLM评估框架

LLM评估采用统一框架，包括：

1. **提示模板设计**：
   - 清晰的评估任务描述
   - 提供问题、系统回答和相关数据
   - 明确的评分标准（高分、中分、低分的界定）
   - 格式要求（仅返回0-1之间的数字）

2. **分数提取**：
   - 使用正则表达式提取数字
   - 确保分数在0-1范围内

3. **错误处理**：
   - LLM不可用时使用默认分数
   - 响应解析失败时使用默认分数

通过这种双层评估机制，系统能够在规则评分不理想时提供更合理的评分结果，避免了仅返回基础分的问题，提高了评估的准确性和稳定性。

## 评估指标总结表

| 指标类型 | 指标名称 | 指标代码 | 计算原理 | LLM回退触发条件 | LLM回退策略 |
|----------|----------|----------|----------|-----------------|-------------|
| **答案质量** | 精确匹配 | `em` | 答案标准化后完全匹配得1.0分，否则计算内容相似度 | 不完全匹配且内容相似度一般 | 评估答案的语义等价性 |
| | F1分数 | `f1` | 基于共有词计算精确率和召回率，F1 = 2 * P * R / (P + R) | 无论F1分数如何 | 评估信息重叠程度，取较高分 |
| | 答案连贯性 | `response_coherence` | 分析答案结构、逻辑流畅程度和组织性 | 主要依赖LLM评估 | 直接评估答案的结构和连贯性 |
| | 事实一致性 | `factual_consistency` | 检查答案是否存在自相矛盾或逻辑错误 | 主要依赖LLM评估 | 评估答案内部的逻辑一致性 |
| | 答案全面性 | `answer_comprehensiveness` | 评估答案是否涵盖问题的所有方面 | 主要依赖LLM评估 | 评估答案对问题的覆盖程度 |
| **检索性能** | 检索精确率 | `retrieval_precision` | 引用实体在检索实体中的匹配比例 | 规则评分 ≤ 0.5 | 评估引用实体与检索实体的匹配度 |
| | 检索利用率 | `retrieval_utilization` | 检索实体在回答中的利用程度 | 规则评分 ≤ 0.5 | 评估系统对检索实体的利用充分程度 |
| | 检索延迟 | `retrieval_latency` | 记录检索时间（秒） | 不使用LLM回退 | 不适用 |
| | 文本块利用率 | `chunk_utilization` | 文本块关键短语在回答中的出现比例 | 规则评分 ≤ 0.4或无法获取文本块内容 | 评估回答对文本块内容的利用程度 |
| **图评估** | 实体覆盖率 | `entity_coverage` | 问题关键词在实体信息中的匹配率 | 规则评分 ≤ 0.4 | 评估实体与问题的相关程度 |
| | 图覆盖率 | `graph_coverage` | 结构得分、相关性得分和连通性得分的加权平均 | 规则评分 ≤ 0.4 | 评估图数据与问题的相关程度 |
| | 关系利用率 | `relationship_utilization` | 数量得分、质量得分和相关性得分的加权平均 | 规则评分 ≤ 0.4或无关系信息 | 评估系统对实体关系的利用程度 |
| | 子图质量 | `subgraph_quality` | 图密度和连通性的加权平均 | 规则评分 ≤ 0.4或无实体关系 | 评估子图的质量和信息密度 |
| | 社区相关性 | `community_relevance` | 问题关键词在社区信息中的匹配率 | 规则评分 ≤ 0.4 | 评估回答与知识社区的相关程度 |

## 评分区间说明

所有指标采用0到1的分数范围，统一解释如下：

| 分数范围 | 性能评价 | 说明 |
|----------|----------|------|
| 0.0-0.3 | 表现较差 | 基础分，低于预期的表现 |
| 0.4-0.7 | 表现一般 | 中等表现，满足基本要求 |
| 0.8-1.0 | 表现优秀 | 高质量表现，显著超出预期 |

## LLM回退框架

LLM回退评估采用统一的处理流程：

1. 构建评估提示，包含评估对象、评分标准和格式要求
2. 提交至LLM获取评分响应
3. 使用正则表达式提取0-1之间的数字作为评分结果
4. 与规则评分比较，取较高值
5. 当LLM不可用或评分提取失败时，使用预设的默认分数