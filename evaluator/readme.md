# GraphRAG 评估系统

GraphRAG 评估系统用于评估不同类型 RAG Agent的性能，包括传统向量检索（Naive RAG）、图检索（Graph RAG）、混合检索（Hybrid RAG）和深度研究（Deep Research）Agent。

## 1. 系统概述

### 1.1 主要功能

- 全面评估四种不同类型的Agent（Naive、Graph、Hybrid、Deep）
- 支持多种评估维度：答案质量、检索性能、图形利用率等
- 提供单独评估和对比评估功能
- 支持自定义评估指标和权重
- 评估结果可视化和详细报告

### 1.2 Agent类型

- **Naive Agent**：传统基于向量检索的 RAG
- **Graph Agent**：使用知识图谱进行检索的 RAG（自动选择Local Search / Global Search）
- **Hybrid Agent**：结合Local Search和 Global Search的混合 RAG，参考LightRAG实现双级检索
- **Deep Agent**：具有深度推理能力的增强 RAG

### 1.3 评估维度

- **答案质量评估**：精确度、完整性、连贯性等
- **检索性能评估**：精确率、利用率、延迟等
- **图评估**：实体覆盖率、关系利用率、子图质量等
- **深度推理评估**：推理连贯性、深度、迭代改进等

## 2. 系统架构

### 2.1 核心组件

- **base_evaluator**：评估器基类，定义通用评估功能和接口
- **base_metric**：评估指标基类，定义计算评估指标的接口
- **评估数据结构**：标准化的数据结构，用于存储和处理评估数据
- **composite_evaluator**：组合评估器，协调多维度评估并生成最终报告

### 2.2 评估指标分类

1. **答案质量指标**
   - `em`：精确匹配 (Exact Match)
   - `f1`：F1分数
   - `response_coherence`：回答连贯性
   - `factual_consistency`：事实一致性
   - `answer_comprehensiveness`：回答全面性
   - `llm_evaluation`：LLM综合评估

2. **检索性能指标**
   - `retrieval_precision`：检索精确率
   - `retrieval_utilization`：检索利用率
   - `retrieval_latency`：检索延迟
   - `chunk_utilization`：文本块利用率

3. **图评估指标**
   - `entity_coverage`：实体覆盖率
   - `graph_coverage`：图覆盖率
   - `relationship_utilization`：关系利用率
   - `community_relevance`：社区相关性
   - `subgraph_quality`：子图质量

4. **深度研究指标**
   - `reasoning_coherence`：推理连贯性
   - `reasoning_depth`：推理深度
   - `iterative_improvement`：迭代改进
   - `knowledge_graph_utilization`：知识图谱利用率

## 3. 评估指标说明

### 3.1 答案质量评估指标

#### 3.1.1 精确匹配 (Exact Match)
评估系统回答与标准答案的精确匹配程度，主要考虑语义等价性。

- **计算原理**：
  - 标准化处理系统答案和参考答案（去除标点、冠词等）
  - 检查完全匹配情况，匹配则得分1.0
  - 不完全匹配时计算内容相似度，并使用LLM评估答案等价性

#### 3.1.2 F1分数
评估系统回答与标准答案的词汇重叠度，平衡精确率和召回率。

- **计算原理**：
  - 对答案进行中文分词并过滤停用词
  - 计算共有词的比例，得出精确率和召回率
  - F1 = 2 * 精确率 * 召回率 / (精确率 + 召回率)

#### 3.1.3 回答连贯性
评估系统回答的结构完整性和逻辑流畅程度。

- **计算原理**：
  - 分析答案的结构特征：段落数、标题、句子数等
  - 基于结构完整性和逻辑流畅程度评分
  - 使用LLM评估连贯性

#### 3.1.4 事实一致性
评估系统回答内部逻辑和事实的一致性，检查是否存在矛盾。

- **计算原理**：
  - 提取答案中的关键信息点
  - 评估信息点之间的逻辑一致性
  - 检查是否存在自相矛盾

#### 3.1.5 回答全面性
评估系统回答是否涵盖问题的各个方面，提供了全面的信息。

- **计算原理**：
  - 评估答案是否涵盖问题的所有方面
  - 检查答案的信息密度和详尽程度
  - 使用LLM评估全面性

#### 3.1.6 LLM综合评估
使用LLM从多个维度评估系统回答的质量，包括全面性、相关性、增强理解能力和直接性。

- **计算原理**：
  - 由LLM评估四个方面：全面性、相关性、增强理解能力、直接性
  - 计算加权总分，权重可配置

### 3.2 检索性能评估指标

#### 3.2.1 检索精确率
评估系统检索到的实体与最终引用的实体的匹配程度。

- **计算原理**：
  - 比较检索到的实体和引用的实体的匹配程度
  - 计算引用实体在检索实体中的出现比例
  - 公式：matched / 引用实体总数

#### 3.2.2 检索利用率
评估系统对检索到的实体的利用程度，检查系统是否充分利用检索结果。

- **计算原理**：
  - 评估系统对检索到的实体的利用程度
  - 检查引用实体在检索实体中的覆盖率
  - 考虑部分匹配和相似性

#### 3.2.3 检索延迟
评估检索过程的时间效率，单位为秒。

- **计算原理**：
  - 记录从提问到获得回答的时间（秒）
  - 直接报告原始时间值，不进行转换

#### 3.2.4 文本块利用率
评估系统对检索到的文本块内容的利用程度。主要适用于NaiveAgent。

- **计算原理**：
  - 从Neo4j获取引用文本块的实际内容
  - 提取文本块的关键短语
  - 计算关键短语在回答中的出现比例
  - 平均所有文本块的利用率

### 3.3 图评估指标

#### 3.3.1 实体覆盖率
评估检索到的实体对问题相关知识点的覆盖程度。

- **计算原理**：
  - 获取引用的实体信息和描述
  - 提取问题关键词
  - 计算关键词在实体信息中的匹配率
  - 考虑实体数量和匹配质量

#### 3.3.2 图覆盖率
评估检索到的知识图谱对问题领域的覆盖程度。

- **计算原理**：
  - 评估三个维度：结构得分、相关性得分和连通性得分
  - 结构得分：基于实体和关系的数量及质量
  - 相关性得分：关键词在图数据中的匹配率
  - 连通性得分：实体之间的连接度

#### 3.3.3 关系利用率
评估系统对实体之间关系的利用程度。

- **计算原理**：
  - 计算数量得分：基于关系数量
  - 计算质量得分：基于关系描述质量和多样性
  - 计算相关性得分：关系中实体与引用实体的重合度
  - 加权平均三个维度的分数

#### 3.3.4 社区相关性
评估检索到的知识社区对问题领域的相关程度。

- **计算原理**：
  - 查询实体关联的社区信息
  - 计算问题关键词在社区信息中的匹配率
  - 根据Agent类型给予不同基础分和加成

#### 3.3.5 子图质量
评估检索到的子图的信息密度和结构质量。

- **计算原理**：
  - 计算图密度：边数与最大可能边数之比
  - 计算连通性：参与关系的实体比例
  - 加权平均密度和连通性得分

### 3.4 深度研究指标

#### 3.4.1 推理连贯性
评估深度研究Agent推理过程的连贯性和逻辑性。

- **计算原理**：
  - 分析思考过程的结构和连贯性
  - 评估搜索查询与推理步骤的关联度
  - 使用LLM评估思考过程的整体连贯性

#### 3.4.2 推理深度
评估深度研究Agent推理过程的深度和复杂性。

- **计算原理**：
  - 计算搜索查询数量和多样性
  - 评估思考过程的层次深度
  - 分析信息提取和整合质量

#### 3.4.3 迭代改进
评估深度研究Agent在多轮推理中的改进程度。

- **计算原理**：
  - 比较首次和最终查询的质量差异
  - 评估信息提取的迭代改进
  - 使用LLM评估整体迭代成效

#### 3.4.4 知识图谱利用率
评估深度研究Agent对知识图谱信息的利用程度(专为DeeperResearch设计)。

- **计算原理**：
  - 分析思考过程中对图谱概念的引用频率
  - 评估实体和社区信息的整合质量
  - 使用LLM评估知识图谱对回答的贡献度

## 4. 使用指南

详见`evaluator/test`文件夹

## 5. 评分机制

### 5.1 评分区间

所有评估指标采用0到1的分数范围：

| 分数范围 | 性能评价 | 说明 |
|----------|----------|------|
| 0.0-0.3 | 表现较差 | 基础分，低于预期的表现 |
| 0.4-0.7 | 表现一般 | 中等表现，满足基本要求 |
| 0.8-1.0 | 表现优秀 | 高质量表现，显著超出预期 |

### 5.2 LLM回退机制

当规则评分分数过低时，系统会使用LLM进行更智能的评估：

1. 构建评估提示，包含评估对象、评分标准和格式要求
2. 提交至LLM获取评分响应
3. 提取0-1之间的数字作为评分结果
4. 与规则评分比较，取较高值
5. 当LLM不可用或评分提取失败时，使用预设的默认分数